name: MCP Security Validation

on:
  pull_request:
  workflow_dispatch:

jobs:
  mcp-security:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    env:
      MCP_SERVER_URL: "http://172.28.0.12:8000/call_tool"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          python -m pip install --upgrade pip
          python -m pip install requests

      - name: Download MCP server reference
        run: |
          curl -o mcp_server.py https://raw.githubusercontent.com/rymarinelli/MPC_OWASP_POC/main/mcp_server.py

      - name: Run MCP scan_repo (remote)
        run: |
          python - << 'PY'
          import json, urllib.request, os
          mcp_url = os.getenv("MCP_SERVER_URL", "http://172.28.0.12:8000/call_tool")
          payload = {
              "tool_name": "scan_repo",
              "params": {
                  "repo_path": ".",
                  "semgrep_config": "p/ci",
                  "llm_proposal": True
              }
          }
          data = json.dumps(payload).encode("utf-8")
          req = urllib.request.Request(
              mcp_url,
              data=data,
              headers={"Content-Type": "application/json"},
              method="POST",
          )
          print(f"Calling MCP server at {mcp_url} ...")
          with urllib.request.urlopen(req) as resp:
              result = json.loads(resp.read().decode("utf-8"))
          with open("mcp_scan.json", "w") as f:
              json.dump(result, f)
          print("âœ… Scan complete.")
          PY

      - name: Create PR comment body
        if: github.event_name == 'pull_request'
        run: |
          COUNT=$(jq '.findings | length' mcp_scan.json)
          REPORT=$(jq -r '.llm_proposal' mcp_scan.json)
          MODEL=$(jq -r '.model_used // "N/A"' mcp_scan.json)

          {
            echo "### ðŸ§© MCP Security Validation"
            echo "**Server:** http://172.28.0.12:8000"
            echo "**Findings:** ${COUNT}"
            echo "**Model:** ${MODEL}"
            echo ""
            echo "#### Proposed remediation (LLM):"
            echo "${REPORT}"
          } > body.md

      - name: Post PR comment
        if: github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body-file body.md

      - name: Show MCP scan output
        if: always()
        run: cat mcp_scan.json || true
